{"createdAt":"2025-08-15T14:57:06.728Z","updatedAt":"2025-08-31T15:42:38.933Z","id":"QIIUgz6qxKWgL4qB","name":"Meta Form Ads","active":true,"isArchived":false,"nodes":[{"parameters":{"page":{"__rl":true,"value":"1472305122820567","mode":"id"},"form":{"__rl":true,"value":"1290978162407224","mode":"id"},"options":{}},"type":"n8n-nodes-base.facebookLeadAdsTrigger","typeVersion":1,"position":[0,0],"id":"b7ebc826-510d-4586-8f73-44edc0b2bf30","name":"Facebook Lead Ads Trigger","webhookId":"be0eabad-5c8e-409c-85a1-c458a8940a60","credentials":{"facebookLeadAdsOAuth2Api":{"id":"8r4zSQYaCp1Kxlvt","name":"Facebook Lead Ads account"}}},{"parameters":{"method":"POST","url":"https://latorre180-dev-alquiler-cotizacion-22440274.dev.odoo.com/crm/webhook","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify((() => {\n  const src = $json || {};\n\n  const get = (...paths) => {\n    for (const p of paths) {\n      const parts = p.split('.');\n      let cur = src;\n      let ok = true;\n      for (let i = 0; i < parts.length; i++) {\n        const part = parts[i];\n        // comprobación segura sin usar prototype/hasOwnProperty\n        if (cur && typeof cur === 'object' && cur[part] !== undefined && cur[part] !== null && String(cur[part]) !== '') {\n          cur = cur[part];\n        } else {\n          ok = false;\n          break;\n        }\n      }\n      if (ok) return cur;\n    }\n    return '';\n  };\n\n  // normaliza tamaños: \"10_pies\" -> \"10 pies\", \"20-pies\" -> \"20 pies\", \"10_pies_extra\" -> \"10 pies extra\"\n  const normalizeSize = (v) => {\n    if (!v && v !== 0) return '';\n    let s = String(v);\n    // reemplaza guiones y guiones bajos por espacios\n    s = s.replace(/[_\\-]+/g, ' ');\n    // normaliza múltiples espacios\n    s = s.replace(/\\s+/g, ' ').trim();\n    // Si aparece \"pies\" pegado a número sin espacio, asegura espacio (ej: \"10pies\" -> \"10 pies\")\n    s = s.replace(/^(\\d+)\\s*pies?$/i, (m, p1) => `${p1} pies`);\n    return s;\n  };\n\n  const flat = {\n    nombre: get('data.nombre','nombre','form.name','data.first_name','name'),\n    apellido: get('data.apellido','apellido','data.last_name','last_name'),\n    correo: get('data.email','email','data.correo','correo'),\n    telefono: get('data.phone','phone','data.telefono','telefono'),\n    servicio: get('data.servicio','servicio','form.servicio'),\n    producto: get('data.producto','producto','form.producto'),\n\n    // <-- aquí añadí las rutas que incluyen \"tamaño\" con ñ (data.tamaño) y variantes --\n    tamano: normalizeSize( get(\n      'data.tamaño',\n      'data.tamano',\n      'body.fields.Tamaño',\n      'body.fields.Tamano',\n      'body.fields.tamano',\n      'form.tamano',\n      'form[\"tamaño\"]',\n      'tamano'\n    ) ),\n\n    mensaje: get('data.cuéntanos_del_proyecto','data.mensaje','mensaje','form[\"cuéntanos_del_proyecto\"]'),\n    page_name: get('page.name','data.page.name','form.name','page'),\n\n    // adset/ad (se mantienen por si los necesitas)\n    adset_name: get('adset.name','data.adset.name','body.adset','body.fields.adset',''),\n    ad_name: get('ad.name','data.ad.name','body.ad','body.fields.ad',''),\n\n    // UTMs: fuente y medio fijos; campaign/content dinámicos desde adset/ad\n    utm_source: 'meta',\n    utm_medium: 'cpc',\n    utm_campaign: (get('data.adset.name','adset.name','body.adset','body.fields.adset') || get('adset.name','data.adset','') || ''),\n    utm_content: (get('data.ad.name','ad.name','body.ad','body.fields.ad') || get('ad.name','data.ad','') || ''),\n    utm_term: 'none',\n\n    raw_payload: src\n  };\n\n  const full = ((flat.nombre || '') + ' ' + (flat.apellido || '')).trim();\n  flat.contact_name = full || flat.page_name || '';\n  flat.name = flat.contact_name || flat.page_name || '';\n\n  return flat;\n})()) }}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[208,0],"id":"4c0f2608-9839-4f3c-a1ea-1277bf351344","name":"HTTP Request"}],"connections":{"Facebook Lead Ads Trigger":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Facebook Lead Ads Trigger":[{"json":{"id":"1139426468005596","data":{"servicio":"comprar","producto":"modulares","tamaño":"10_pies","cuéntanos_del_proyecto":"Barbaeria","apellido":"Test","nombre":"Súper","email":"josekcastillo01@gmail.com","phone":"+50766554433"},"form":{"id":"1290978162407224","name":"Torre 180 - Ago 2025 - V1","locale":"es_LA","status":"ACTIVE"},"ad":{},"adset":{},"page":{"name":"La Torre 180","id":"1472305122820567"},"created_time":"2025-08-15T20:53:08+0000"}}]},"versionId":"367bffb2-3976-4682-bf5f-0dedc979bddb","triggerCount":1,"tags":[]}